name: Lint + Unit tests + Build + Deploy

on:
  push:
  pull_request:
    types: [opened]

env:
  TELEGRAM_GROUP_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  install-cache:
    name: Install cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Commit
        uses: actions/checkout@v5

      - name: Cache npm dependencies
        id: cache-ci
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install Dependencies
        if: steps.cache-ci.outputs.cache-hit != 'true'
        run: npm ci

  eslint-check:
    name: Eslint check
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run ESLint
        uses: wearerequired/lint-action@v2
        with:
          eslint: true
          prettier: false
          stylelint: false
          auto_fix: false

  prettier-check:
    name: Prettier check
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run Prettier
        uses: wearerequired/lint-action@v2
        with:
          eslint: false
          prettier: true
          stylelint: false
          auto_fix: false

  stylelint-check:
    name: Stylelint check
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run Stylelint
        run: npm run lint:stylelint

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run tests
        run: npm run test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs:
      - install-cache
      - eslint-check
      - prettier-check
      - stylelint-check
      - unit-tests
    steps:
      - name: Checkout Commit
        uses: actions/checkout@v5

      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}

      - name: –°–æ–∑–¥–∞–Ω–∏–µ env —Ñ–∞–π–ª–∞
        run: |
          touch .env
          echo VITE_SENTRY_DSN=${{ secrets.SENTRY_DSN }} >> .env
          echo VITE_SENTRY_AUTH_TOKEN=${{ secrets.VITE_SENTRY_AUTH_TOKEN }} >> .env
          echo VITE_SENTRY_ORG=${{ secrets.VITE_SENTRY_ORG }} >> .env
          echo VITE_SENTRY_PROJECT=${{ secrets.VITE_SENTRY_PROJECT }} >> .env
          echo VITE_CDN_ADRESS=${{ secrets.VITE_CDN_ADRESS }} >> .env
          echo VITE_SENTRY_ENABLED=${{ secrets.VITE_SENTRY_ENABLED }} >> .env
          cat .env

      - name: Build project
        run: npm run build

      - name: Save build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist
          retention-days: 1

      - name: Save static artifacts
        uses: actions/upload-artifact@v4
        with:
          name: static
          path: static
          retention-days: 1

  deploy-static:
    name: Deploy static to s3
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@main
        with:
          name: static
          path: static
      - name: Deploy static folder to S3 bucket
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --acl public-read --follow-symlinks --delete --no-verify-ssl
        env:
          AWS_S3_ENDPOINT: ${{secrets.AWS_S3_ENDPOINT}}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'ru-7'
          SOURCE_DIR: 'static'
          DEST_DIR: 'static'

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist
      - name: Clean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo chown -R ubuntu:ubuntu /opt/public
            sudo rm -rf /opt/public/*
      - name: Deploy to server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'dist/*'
          target: '/opt/public'
          overwrite: true
          strip_components: 1

  notify_success:
    name: Success Message
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send Telegram Success Message
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã

            üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–¥ üîó
            ${{ secrets.PRODUCTION_URL || '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}

  notify_failure:
    name: Failure Message
    if: ${{ needs.deploy.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Failure Message
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            ‚ùóÔ∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –¥–µ–ø–ª–æ—è

            üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–π–ø–ª–∞–π–Ω üîó
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
