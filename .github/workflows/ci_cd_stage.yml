name: Stage flow

on:
  push:
    branches-ignore:
      - main
      - develop

env:
  TELEGRAM_GROUP_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  install-cache:
    name: Install cache
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Commit
        uses: actions/checkout@v5

      - name: Cache npm dependencies
        id: cache-ci
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install Dependencies
        if: steps.cache-ci.outputs.cache-hit != 'true'
        run: npm ci

  eslint-check:
    name: Eslint check
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run ESLint
        run: |
          npm run lint:eslint
      - name: Send Telegram Failure Message
        if: failure() 
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â—ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ESLint

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  prettier-check:
    name: Prettier check
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run Prettier
        run: |
          npm run lint:prettier
      - name: Send Telegram Failure Message
        if: failure() 
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â—ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Prettier

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  stylelint-check:
    name: Stylelint check
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run Stylelint
        run: npm run lint:stylelint
      - name: Send Telegram Failure Message
        if: failure() 
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â—ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Stylelint

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v5
      - name: Restore npm cache
        uses: actions/cache@v4
        id: cache-ci
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Run tests
        run: npm run test
      - name: Send Telegram Failure Message
        if: failure() 
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â—ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Unit tests

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs:
      - install-cache
      - eslint-check
      - prettier-check
      - stylelint-check
      - unit-tests
    steps:
      - name: Pull code
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/ubuntu/frontend/stage
            git fetch
            git reset --hard origin/${{ github.ref_name }}

      - name: Deploy to S3
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/ubuntu/frontend/stage
            
            source .env.stage

            docker build -f Dockerfile.stage \
            --target deploy \
            --build-arg AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
            --build-arg AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
            --build-arg AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION \
            --build-arg S3_BUCKET=$S3_BUCKET \
            --build-arg AWS_ENDPOINT=$AWS_ENDPOINT \
            -t frontend-stage:latest .

      - name: Build frontend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/ubuntu/frontend/stage
  
            docker compose -f docker-compose.stage.yml --env-file .env.stage down -v
            docker compose --env-file .env.stage -f docker-compose.stage.yml build --no-cache
            docker compose --env-file .env.stage -f docker-compose.stage.yml up -d
      
      - name: Send failure notification
        if: failure()
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â—ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Telegram Success Message
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            ğŸ”” Frontend (Stage)
            âœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ½Ñ‹

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° ğŸ”—
            ${{ secrets.STAGE_URL || 'ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' }}

  integration-tests-run:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout Commit
        uses: actions/checkout@master

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
        uses: actions/setup-node@master
        with:
          node-version: 24

      - name: Restore npm dependencies
        uses: actions/cache@master
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cypress run
        uses: cypress-io/github-action@v6
        env:
          CYPRESS_BASE_URL: ${{ secrets.STAGE_URL }}

      - name: Generate Report
        if: always()
        run: npm run allure:generate

      - name: Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@master
        with:
          name: allure-results
          path: |
            allure-results/
            allure-report/
            cypress/results/test-results-*.xml
          retention-days: 7

  deploy-allure-report:
    runs-on: ubuntu-latest
    needs: integration-tests-run
    if: always()
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Download results artifact
        uses: actions/download-artifact@master
        with:
          name: allure-results
          path: ./

      - name: Get Allure history
        uses: actions/checkout@master
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate and publish Allure report
        uses: simple-elf/allure-report-action@master
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-history

      - name: Get Allure Report URL
        id: allure-url
        run: |
          REPORT_DIR="${{ github.run_number }}"
          echo "report_url=https://${{ secrets.ALLURE_URL }}/$REPORT_DIR/" >> $GITHUB_OUTPUT

      - name: Parse and Publish Test Results
        uses: mikepenz/action-junit-report@v6
        id: parse-report
        if: always()
        with:
          check_name: Cypress Test Results
          report_paths: 'cypress/results/test-results-*.xml'
          include_passed: true
          job_summary: false

      - name: Calculate total execution time from all XML files
        id: parse_xml
        if: always()
        run: |
          TOTAL_TIME=0
          
          for xml_file in cypress/results/test-results-*.xml; do
            if [ -f "$xml_file" ]; then
              root_time=$(grep -o 'testsuites.*time="[^"]*"' "$xml_file" 2>/dev/null | grep -o 'time="[^"]*"' | cut -d'"' -f2)
              root_time=${root_time:-0}
          
              TOTAL_TIME=$(echo "$TOTAL_TIME + $root_time" | bc -l 2>/dev/null || echo "$TOTAL_TIME")
            fi
          done
          
          if [ -z "$TOTAL_TIME" ] || [ "$TOTAL_TIME" = "0" ]; then
            TOTAL_TIME="0"
            else
            TOTAL_TIME=$(printf "%.1f" $TOTAL_TIME 2>/dev/null || echo "0")
          fi
          
          echo "Total execution time: $TOTAL_TIME seconds"
          echo "executionTime=$TOTAL_TIME" >> $GITHUB_OUTPUT

      - name: Send Telegram Report Status
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            ${{ needs.integration-tests-run.result == 'success' && 'âœ… Tests passing' || 'âŒ Tests failed' }}
            
            ğŸ§ª Total: ${{steps.parse-report.outputs.total}}
            âŒ Failed: ${{steps.parse-report.outputs.failed}}
            âœ… Passed: ${{steps.parse-report.outputs.passed}}
            â±ï¸ Duration: ${{steps.parse_xml.outputs.executionTime}} s
            
            ğŸ“Š Allure
            ${{ steps.allure-url.outputs.report_url }}
